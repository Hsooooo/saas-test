<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
@Getter
@Setter
@Alias("InvoiceVO")
public class InvoiceVO {
    private Integer idx;
    private Integer partnershipIdx;
    private Integer licensePartnershipIdx;
    private LocalDate periodStart;
    private LocalDate periodEnd;
    private ZonedDateTime issueDate;
    private ZonedDateTime dueDate;
    private Double subtotal;
    private Double tax;
    private Double total;
    private String statusCd;
    private String unitCd;
    private String meta;
    private ZonedDateTime createDate;
    private ZonedDateTime updateDate;
}
 -->
<mapper namespace="com.illunex.emsaasrestapi.payment.mapper.InvoicePaymentViewMapper">
    <!-- 인보이스 총액/수납합계/잔액 조회 -->
    <select id="selectInvoicePaymentSummary" resultType="InvoicePaymentView">
        SELECT
            i.idx AS invoiceId,
            i.total AS invoiceTotal,
            COALESCE(SUM(p.amount),0) AS paidTotal,
            (i.total - COALESCE(SUM(p.amount),0)) AS balanceDue
        FROM invoice i
                 LEFT JOIN license_payment_history p ON p.invoice_idx = i.idx
        WHERE i.idx = #{invoiceId}
        GROUP BY i.idx, i.total
    </select>

    <select id="selectDefaultMethodAndMandate" resultType="map">
        SELECT
            pm.idx AS paymentMethodIdx,
            md.idx AS paymentMandateIdx,
            md.provider_cd AS providerCd,
            md.mandate_id AS mandateId,
            pm.customer_key AS customerKey
        FROM partnership_payment_method pm
                 JOIN payment_mandate md
                      ON md.partnership_idx = pm.partnership_idx
                          AND md.payment_method_idx = pm.idx
                          AND md.status_cd = 'MDS0001' /* ACTIVE */
        WHERE pm.partnership_idx = #{partnershipIdx}
          AND pm.is_default = 1
          AND pm.state_cd = 'PSC0001' /* ACTIVE */
        ORDER BY md.create_date DESC
            LIMIT 1
    </select>

    <select id="selectAllBySearchInvoiceAndPageable" resultType="InvoiceListViewVO">
        SELECT
            i.idx               AS invoice_idx,
            i.issue_date        AS pay_date,
            l_snap.name AS plan_name,
            i.charge_user_count AS seat_count,
            i.total             AS amount,
            i.period_start,
            i.period_end,
            i.type_cd,
            lp.license_idx,
            i.license_idx,
            CASE
                -- 조정 인보이스: 앵커(=period_end, exclusive) 전까지 '구독중', 이후 '기한만료'
                WHEN i.type_cd = 'IIT0002' THEN
                    CASE
                        WHEN CURDATE() <![CDATA[<]]>  i.period_end THEN '구독중'
                        ELSE '기한만료'
                        END
                -- 정기 인보이스
                WHEN i.period_end <![CDATA[<=]]> CURDATE() THEN '기한만료'
                WHEN i.period_start >  CURDATE() THEN '구독중'
                WHEN lp.license_idx <![CDATA[<>]]> i.license_idx THEN '기한만료'   -- 업그레이드 등으로 현재 플랜 불일치 시 강제 만료
                ELSE CASE lp.state_cd
                         WHEN 'LPS0003' THEN '구독중(변경예약)'
                         WHEN 'LPS0004' THEN '구독중(해지예약)'
                         ELSE '구독중'
                    END
                END AS display_state,
            i.receipt_url
        FROM invoice i
                 LEFT JOIN license_partnership lp ON lp.idx = i.license_partnership_idx
                 LEFT JOIN license l_snap         ON l_snap.idx = i.license_idx
        WHERE i.partnership_idx = #{searchInvoice.partnershipIdx}
          AND i.status_cd NOT IN ('ICS0004','ICS0001') -- VOID,DRAFT 제외 필요 시 조정
          AND i.issue_date >=
        CASE #{searchInvoice.range}
            WHEN 'M1' THEN DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
            WHEN 'M3' THEN DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
            WHEN 'M6' THEN DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
            WHEN 'Y1' THEN DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
            ELSE DATE_SUB(CURDATE(), INTERVAL 1 MONTH) -- default
            END
        <if test="pageable.sort != null and !pageable.sort.empty">
            ORDER BY
            <foreach item="order" collection="pageable.sort" separator=",">
                ${order.property} ${order.direction}
            </foreach>
        </if>
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>

    <select id="countAllBySearchInvoice">
        SELECT
            COUNT(*) AS total_count
        FROM invoice i
                 LEFT JOIN license_partnership lp
                           ON lp.idx = i.license_partnership_idx
        WHERE i.partnership_idx = #{partnershipIdx}
          AND i.status_cd NOT IN ('ICS0004','ICS0001') -- VOID,DRAFT 제외 필요 시 조정
          AND i.issue_date >=
              CASE #{range}
                  WHEN 'M1' THEN DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
                  WHEN 'M3' THEN DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
                  WHEN 'M6' THEN DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
                  WHEN 'Y1' THEN DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
                  ELSE DATE_SUB(CURDATE(), INTERVAL 1 MONTH) -- default
                  END
    </select>

</mapper>